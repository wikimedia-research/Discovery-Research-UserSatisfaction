---
title: "Initial analysis of the TestSearchSatisfaction data to validate that the theory
  works"
author: "Mikhail Popov"
date: "August 17, 2015"
output:
  html_document:
    keep_md: yes
    theme: readable
    toc: yes
---

 This analysis is meant to address the Phabricator task [T105355](https://phabricator.wikimedia.org/T105355).

## Prerequisities

This notebook uses the following packages: magrittr, tidyr, dplyr, knitr, ggplot2, ggthemes, scales, and printr.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
c("magrittr", "tidyr", "knitr", "ggplot2", "ggthemes", "printr") %>%
  sapply(library, character.only = TRUE) %>% invisible
import::from(dplyr, select, arrange, desc,
                    tbl_df, rename, mutate,
                    left_join, right_join, inner_join, bind_rows, bind_cols,
                    summarise, group_by, ungroup, keep_where = filter)
```

## Data Preparation

Oliver Keyes prepared the data for analysis (read it in, cleaned up timestamps, and parsed user agents).

```{r, echo = FALSE, eval = FALSE}
setwd('analysis_T105355')
load('second_ab_run.RData')
ls()
control_agents %<>% tbl_df
control_data %<>% tbl_df
hyp_agents %<>% tbl_df
hyp_data %<>% tbl_df

library(uaparser)
hyp_parsedUserAgent <- parse_agents(hyp_data$userAgent)
hyp_data <- dplyr::bind_cols(hyp_data, hyp_parsedUserAgent)
control_parsedUserAgent <- parse_agents(control_data$userAgent)
control_data <- dplyr::bind_cols(control_data, control_parsedUserAgent)
rm(hyp_parsedUserAgent, control_parsedUserAgent)

hyp_data$timestamp <- as.POSIXct(hyp_data$timestamp)
control_data$timestamp <- as.POSIXct(control_data$timestamp)

save.image('second_ab_run_tbl-df.RData')
```

```{r}
# setwd('analysis_T105355')
load('second_ab_run_tbl-df.RData')
```

## Notes to self

### control_data

|control_data               |comment                          |
|:--------------------------|:--------------------------------|
|uuid                       |Unique user ID
|clientIp                   ||
|timestamp                  ||
|userAgent                  ||
|webHost                    ||
|wiki                       ||
|event_action               ||
|event_clickIndex           ||
|event_numberOfResults      ||
|event_platform             ||
|event_resultSetType        ||
|event_searchSessionToken   ||
|event_timeOffsetSinceStart ||
|event_timeToDisplayResults ||
|event_userSessionToken     ||

### hyp_data (hypothesis data)

|column name           | comment                      |
|:---------------------|:-----------------------------|
|uuid                  ||
|clientIp              ||
|timestamp             ||
|userAgent             ||
|webHost               ||
|wiki                  ||
|event_action          | Identifies the context in which the event was created. When the user clicks a link in the results a visitPage event is created. |
|event_depth           | Records how many clicks away from the search page the user currently is. |
|event_logId           | A unique identifier generated per event. |
|event_pageId          | A unique identifier generated per visited page. This allows a visitPage event to be correlated with a leavePage event. |
|event_searchSessionId | A unique identifier generated per search session. |
|device                     ||
|os                         ||
|os_major                   ||
|os_minor                   ||
|os_patch                   ||
|os_patch_minor             ||
|browser                    ||
|browser_major              ||
|browser_minor              ||
|browser_patch              ||
|browser_patch_minor        ||

## Bias Checking

```{r, fig.width = 9, fig.height = 8, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
final_set <- rbind(hyp_agents[hyp_agents$agent %in% control_agents$agent[1:10],],
                   control_agents[1:10,],
                   data.frame(agent = control_agents$agent[1:10][!control_agents$agent[1:10] %in% hyp_agents$agent],
                              Freq = 0,
                              percentage = 0,
                              sample = "User Satisfaction Schema",
                              stringsAsFactors = FALSE))
ggplot(data = final_set,
       aes(x = reorder(agent, percentage),
           y = percentage,
           fill = factor(sample))) +
  geom_bar(stat="identity", position = "dodge") +
  theme_fivethirtyeight() +
  scale_x_discrete("User Agent") +
  scale_fill_discrete("Sample") +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip() +
  geom_text(aes(label = sprintf("%.2f%%", 100 * percentage)),
            position = position_dodge(width = 1),
            size = 3) +
  labs(title = "Browser usage, User Satisfaction schema versus control")
# ggsave(p, file = "browser.png", height = 6, width = 6, units = "in", dpi = 300, scale = 1.5)
rm(final_set)
```

Let's take a look at proportions of (known) spiders in our datasets...

```{r, echo = FALSE, results = 'asis'}
cbind(Controls = sprintf("%.3f%%",
                         100*sum(control_data$device == "Spider")/nrow(control_data)),
      Hypothesis = sprintf("%.3f%%",
                           100*sum(hyp_data$device == "Spider")/nrow(hyp_data))) %>%
  kable
```

```{r, fig.width = 9, fig.height = 8, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
#Parse agents and identify mobile/desktop/common patterns
handle_uas <- function(dataset, name){
  #Deduplicate
  dataset <- dataset[!duplicated(dataset[,c("clientIp", "userAgent")]), ]
  
  results <- paste(dataset$browser, dataset$browser_major) %>%
    table %>%
    as.data.frame(stringsAsFactors = FALSE)
  results$percentage <- results$Freq/sum(results$Freq)
  results <- results[order(results$percentage, decreasing = TRUE),]
  names(results)[1] <- "agent"
  results$sample <- name
  
  results_2 <- dataset$os %>% table %>%
    as.data.frame(stringsAsFactors = FALSE)
  results_2$percentage <- results_2$Freq/sum(results$Freq)
  results_2 <- results_2[order(results_2$percentage, decreasing = TRUE),]
  names(results_2)[1] <- "os"
  results_2$sample <- name
  
  results_3 <- paste(dataset$os, ":", dataset$browser, dataset$browser_major) %>%
    table %>%
    as.data.frame(stringsAsFactors = FALSE)
  results_3$percentage <- results_3$Freq/sum(results_3$Freq)
  results_3 <- results_3[order(results_3$percentage, decreasing = TRUE),]
  names(results_3)[1] <- "os_agent"
  results_3$sample <- name
  
  return(list(browser = results, os = results_2, both = results_3))
}

hyp_agents_nonauto <- hyp_data %>%
  keep_where(device != "Spider") %>%
  handle_uas("User Satisfaction Schema")

control_agents_nonauto <- control_data %>%
  keep_where(device != "Spider") %>%
  handle_uas("Control Sample")
```

```{r, fig.width = 9, fig.height = 8, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
browsers <- bind_rows(control_agents_nonauto$browser, hyp_agents_nonauto$browser)
browsers %>%
  group_by(agent) %>%
  summarise(TotalFreq = sum(Freq)) %>%
  dplyr::top_n(10, TotalFreq) %>%
  select(-TotalFreq) %>%
  left_join(browsers) %>%
  ggplot(data = .,
         aes(x = reorder(agent, percentage),
             y = percentage,
             fill = factor(sample))) +
  geom_bar(stat="identity", position = "dodge") +
  theme_fivethirtyeight() +
  scale_x_discrete("User Agent") +
  scale_fill_discrete("Sample") +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip() +
  geom_text(aes(label = sprintf("%.2f%%", 100 * percentage)),
            position = position_dodge(width = 1),
            size = 3) +
  labs(title = "Browser usage, User Satisfaction schema versus control\n(Non-Spiders)")
# ggsave(p, file = "browser_nonauto.png", height = 6, width = 6, units = "in", dpi = 300, scale = 1.5)
rm(browsers)
```

```{r, fig.width = 9, fig.height = 8, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
oses <- bind_rows(control_agents_nonauto$os, hyp_agents_nonauto$os)
oses %>%
  group_by(os) %>%
  summarise(TotalFreq = sum(Freq)) %>%
  dplyr::top_n(10, TotalFreq) %>%
  select(-TotalFreq) %>%
  left_join(oses) %>%
  ggplot(data = .,
         aes(x = reorder(os, percentage),
             y = percentage,
             fill = factor(sample))) +
  geom_bar(stat="identity", position = "dodge") +
  theme_fivethirtyeight() +
  scale_x_discrete("Operating System") +
  scale_fill_discrete("Sample") +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip() +
  geom_text(aes(label = sprintf("%.2f%%", 100 * percentage)),
            position = position_dodge(width = 1),
            size = 3) +
  labs(title = "OS usage, User Satisfaction schema versus control\n(Non-Spiders)")
# ggsave(p, file = "systems_nonauto.png", height = 6, width = 6, units = "in", dpi = 300, scale = 1.5)
rm(oses)
```

```{r, fig.width = 10, fig.height = 10, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
both <- bind_rows(control_agents_nonauto$both, hyp_agents_nonauto$both) %>%
  separate(os_agent, c("os", "agent"),sep = " : ", remove = FALSE)

top_browsers <- both %>%
  group_by(agent) %>%
  summarise(TotalFreq = sum(Freq)) %>%
  dplyr::top_n(10, TotalFreq) %>%
  select(-TotalFreq) %>%
  unlist

top_systems <- both %>%
  group_by(os) %>%
  summarise(TotalFreq = sum(Freq)) %>%
  dplyr::top_n(10, TotalFreq) %>%
  select(-TotalFreq) %>%
  unlist

both %>%
  keep_where(os %in% top_systems & agent %in% top_browsers) %>%
  ggplot(data = .,
         aes(x = sample,
             y = percentage,
             fill = factor(sample))) +
  facet_grid(os ~ agent) +
  geom_bar(stat="identity", position = "dodge") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  # theme_fivethirtyeight() +
  scale_x_discrete(breaks = NULL) +
  scale_fill_discrete("Sample") +
  scale_y_continuous(breaks = NULL) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * percentage)),
            position = position_dodge(width = 1),
            size = 3) +
  labs(title = "OS and Browser usage, User Satisfaction schema Vs. control (Non-Spiders)")
# ggsave(p, file = "os_by_browser.pdf", height = 10, width = 7.5, units = "in", scale = 2)
rm(p)
```
